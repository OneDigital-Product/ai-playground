## Convex Monorepo Backend Plan (Turborepo + pnpm)

This plan describes creating a single Convex backend inside `packages/backend` that is shared by multiple frontend apps in this Turborepo. It includes folder structure, package wiring, scripts, and how frontends consume the backend.

---

### Goals
- One Convex backend (single deployment) located under `packages/backend/convex`.
- Reusable across all apps in `apps/*` via workspace dependency.
- Type-safe consumption via generated `convex/_generated` API.
- Clear local dev and deployment workflows.

---

### Current repo context
- Turborepo with pnpm workspaces (turbo.json, pnpm-workspace.yaml present).
- Apps under `apps/` and shared packages under `packages/`.
- No existing Convex project configured yet (Convex MCP indicated no CONVEX_DEPLOYMENT).

---

## Folder Structure

Create a new workspace package `packages/backend` containing the Convex project:

```
repo/
  apps/
    admin/
    web/
    docs/
    host/
  packages/
    backend/
      convex/
        _generated/            # generated by `npx convex dev` (api, dataModel, server)
        schema.ts              # Convex schema
        functions/             # queries/mutations/actions (e.g., messages.ts)
        http/                  # optional HTTP router/actions
        auth.config.ts         # optional (Convex Auth) if needed later
        convex.config.ts       # defineApp + components
      package.json
      tsconfig.json
      convex.json              # Convex config (codegen, bundling)
      README.md
      turbo.json               # optional per‑package tweaks
```

Notes:
- Only files inside `packages/backend/convex/` are deployed to Convex; `_generated/` is written by the CLI.
- Keep frontend-only helpers out of this package. Frontends use the Convex JS client directly.

---

## Backend package.json (reference)

Use an internal workspace name consistent with others (e.g. `@repo/*`).

Example package.json:

```
{
  "name": "@repo/backend",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "convex dev",
    "deploy": "convex deploy",
    "lint": "eslint .",
    "check-types": "tsc --noEmit"
  },
  "dependencies": {
    "convex": "^1.16.0"
  },
  "devDependencies": {
    "@repo/eslint-config": "workspace:*",
    "@repo/typescript-config": "workspace:*",
    "typescript": "5.9.2",
    "eslint": "^9.33.0"
  }
}
```

Notes:
- `convex` is required here because `convex dev` and runtime types come from it.
- Frontends will also add `convex` (client + hooks) in their own `dependencies` when they start consuming.

---

## convex.json

Configure code generation for portability and performance (static types) and leave room for bundling config later if needed:

```
{
  "codegen": {
    "staticApi": true,
    "staticDataModel": true
  }
}
```

Optional (only if using Node externals in functions):
```
{
  "node": {
    "externalPackages": ["*"]
  }
}
```

---

## convex.config.ts

Register components in one place (optional now, useful later):

```
// packages/backend/convex/convex.config.ts
import { defineApp } from "convex/server";

const app = defineApp();

// Example later:
// import shardedCounter from "@convex-dev/sharded-counter/convex.config";
// app.use(shardedCounter);

export default app;
```

---

## Schema and function skeletons

```
// packages/backend/convex/schema.ts
import { defineSchema, defineTable } from "convex/schema";

export default defineSchema({
  messages: defineTable({
    body: "string",
    author: "string"
  })
});
```

```
// packages/backend/convex/functions/messages.ts
import { v } from "convex/values";
import { query, mutation } from "./_generated/server";

export const list = query({
  args: {},
  handler: async ({ db }) => {
    return await db.query("messages").collect();
  }
});

export const send = mutation({
  args: { body: v.string(), author: v.string() },
  handler: async ({ db }, { body, author }) => {
    await db.insert("messages", { body, author });
  }
});
```

---

## tsconfig.json (backend)

Use the shared TypeScript config if present:

```
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "rootDir": ".",
    "noEmit": true
  },
  "include": ["convex/**/*", "*.ts"]
}
```

---

## Turborepo wiring

- pnpm-workspace.yaml already includes `packages/*`, so no change needed.
- To participate in `pnpm dev` and `turbo run dev`, ensure the backend has a `dev` script. Turborepo will start it alongside apps.
- Optional per-package turbo.json to tweak outputs:

```
// packages/backend/turbo.json
{
  "extends": ["//"],
  "tasks": {
    "dev": { "cache": false, "persistent": true },
    "build": { "outputs": ["convex/_generated/**"] }
  }
}
```

---

## Local development workflow

1) Install deps
- `pnpm install`

2) Initialize Convex project (first time only)
- `pnpm --filter @repo/backend exec npx convex dev`
  - Follow prompts to log in and create a development deployment.
  - This writes `.env.local` inside `packages/backend/` with `CONVEX_DEPLOYMENT=...` and generates `convex/_generated/`.
  - Leave it running during dev, or stop once types are generated.

3) Run everything in one command
- `pnpm dev` (Turbo will start apps’ dev servers and `@repo/backend`’s `convex dev`).

4) Frontend configuration for client URL
- Each app needs `NEXT_PUBLIC_CONVEX_URL` set to the Convex deployment URL (from the Convex dashboard or `convex dev` output).
  - For local dev with Convex Cloud, the URL looks like `https://<slug>.convex.cloud`.
  - Add to `apps/<app>/.env.local`:
    - `NEXT_PUBLIC_CONVEX_URL=https://<your>.convex.cloud`

---

## How frontends consume the backend

Add the backend as a workspace dependency and use Convex client + generated API types.

1) Add deps to each app
- In `apps/web/package.json` (and others):
  - `"@repo/backend": "workspace:*"`
  - `"convex": "^1.16.0"` (client + hooks)

2) Create a Convex client in each app

```
// apps/web/src/convexClient.ts
import { ConvexReactClient } from "convex/react";

export const convex = new ConvexReactClient(
  process.env.NEXT_PUBLIC_CONVEX_URL as string
);
```

3) Provide the client

```
// apps/web/src/app/providers.tsx (or similar)
"use client";
import { ConvexProvider } from "convex/react";
import { convex } from "../convexClient";

export function Providers({ children }: { children: React.ReactNode }) {
  return <ConvexProvider client={convex}>{children}</ConvexProvider>;
}
```

4) Call functions using the generated API from the backend package

```
// apps/web/src/app/page.tsx
import { useQuery, useMutation } from "convex/react";
import { api } from "@repo/backend/convex/_generated/api";

export default function Page() {
  const messages = useQuery(api.functions.messages.list) ?? [];
  const send = useMutation(api.functions.messages.send);

  return (
    <div>
      <button onClick={() => send({ body: "hi", author: "web" })}>Send</button>
      <ul>
        {messages.map((m) => (
          <li key={m._id}>{m.author}: {m.body}</li>
        ))}
      </ul>
    </div>
  );
}
```

Notes:
- Import only from `@repo/backend/convex/_generated/*` in apps to avoid bundling server code. Do not import server implementations.
- Avoid importing anything from `convex/server` in apps. Client-side code should use `convex/react` and generated `api` types.

---

## Deployment workflow

- Backend (Convex):
  - From `packages/backend`: `pnpm deploy` (runs `convex deploy`).
  - Use the Convex dashboard to manage environment variables, prod deployments, and domains.
- Frontends (Vercel):
  - Set `NEXT_PUBLIC_CONVEX_URL` per app and environment to point to the intended Convex deployment (preview vs production).
  - The existing Vercel + Turborepo setup (ignoreCommand) remains unchanged.

---

## Summary of changes to make

1) Create `packages/backend/` with:
- `package.json`, `tsconfig.json`, `convex.json`, `turbo.json` (optional)
- `convex/` containing `schema.ts`, `functions/messages.ts`, `convex.config.ts`

2) Initialize Convex:
- `pnpm --filter @repo/backend exec npx convex dev` to create a dev deployment and generate types.

3) Update apps to consume:
- Add deps: `@repo/backend` and `convex`.
- Provide `ConvexProvider` with `ConvexReactClient` using `NEXT_PUBLIC_CONVEX_URL`.
- Import API from `@repo/backend/convex/_generated/api`.

4) Configure env:
- Set `NEXT_PUBLIC_CONVEX_URL` per app and environment.

This structure follows Convex + Turborepo best practices for reusability and type safety while keeping the backend in a single place shared across multiple apps.

