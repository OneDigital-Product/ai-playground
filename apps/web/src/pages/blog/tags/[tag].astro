---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => !data.draft);
  const tags = [...new Set(posts.flatMap((p) => p.data.tags ?? []))];
  return tags.map((t) => ({ params: { tag: t } }));
}

const { tag } = Astro.params;
const posts = (await getCollection("blog", ({ data }) => !data.draft && (data.tags ?? []).includes(tag!))).sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);
---

<BaseLayout title={`Tag: ${tag}`} description={`Posts tagged ${tag}`}>
  <main class="mx-auto max-w-3xl p-6">
    <header class="mb-8">
      <h1 class="text-3xl font-bold">Tag: {tag}</h1>
      <p class="text-neutral-600">All posts tagged with “{tag}”.</p>
    </header>

    {posts.length === 0 ? (
      <p>No posts found for this tag.</p>
    ) : (
      <ul class="space-y-6">
        {posts.map((p) => {
          const href = `/app/blog/${p.slug}`;
          return (
            <li class="border rounded-lg p-4 hover:shadow-sm transition">
              <article>
                <header class="mb-2">
                  <h2 class="text-xl font-semibold"><a href={href} class="hover:underline">{p.data.title}</a></h2>
                  <p class="text-sm text-neutral-500">{p.data.pubDate.toLocaleDateString()}</p>
                </header>
                <p class="text-neutral-700 mb-3">{p.data.description}</p>
              </article>
            </li>
          );
        })}
      </ul>
    )}

    <nav class="mt-8">
      <a href="/app/blog" class="text-blue-600 hover:underline">← All posts</a>
    </nav>
  </main>
</BaseLayout>

